#!/bin/bash

# Bunnify Test Runner Script

# Function to display help
show_help() {
    cat << EOF
ðŸ° Bunnify - Test Runner

USAGE:
    ./test_bunnify [OPTIONS] [TEST_PATH]

DESCRIPTION:
    Runs Django tests using uv package manager.
    Automatically handles the virtual environment.

OPTIONS:
    -h, --help
        Display this help message and exit

    -v, --verbosity LEVEL
        Set test verbosity (0, 1, 2, or 3)
        Default: 1

EXAMPLES:
    # Run all tests
    ./test_bunnify

    # Run specific test suite
    ./test_bunnify bookmarks.tests.SmokeTests

    # Run with verbose output
    ./test_bunnify -v 2

    # Run specific test
    ./test_bunnify bookmarks.tests.SmokeTests.test_search_with_parameter

    # Run all tests with maximum verbosity
    ./test_bunnify -v 3

TEST COVERAGE:
    - Page loading (index, list, command palette, OpenSearch XML)
    - Search redirects with/without parameters
    - Parameter substitution in URLs
    - Direct bookmark redirects
    - Help command functionality
    - API suggestions endpoint
    - Model methods and ordering
    - Error handling (404, 400)

EOF
}

# Check if help is requested
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

# Get the script's directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Check if venv exists
if [ ! -d ".venv" ] && [ ! -f "pyproject.toml" ]; then
    echo "âŒ Error: Project not initialized"
    echo "Please run: uv sync"
    exit 1
fi

# Run tests with all arguments passed through
echo "ðŸ§ª Running tests..."
uv run python manage.py test "$@"
TEST_EXIT_CODE=$?

# Report results
if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "âœ… All tests passed!"
else
    echo "âŒ Tests failed with exit code $TEST_EXIT_CODE"
fi

exit $TEST_EXIT_CODE
